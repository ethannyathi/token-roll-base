# Base Pay Architecture Diagram

## 🏗️ System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         USER INTERFACE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   XPStore    │  │ BasePayCheck │  │  InAppPurch  │        │
│  │  Component   │  │out Component │  │   Component  │        │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
│         │                  │                  │                 │
│         └──────────────────┴──────────────────┘                 │
│                            │                                     │
└────────────────────────────┼─────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      SERVICE LAYER                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │           basePay.ts (Service)                          │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  • processPayment(options)                              │  │
│  │  • checkPaymentStatus(id, testnet)                      │  │
│  │  • pollPaymentStatus(id, testnet, attempts, interval)   │  │
│  └─────────────────────┬───────────────────────────────────┘  │
│                        │                                        │
└────────────────────────┼────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   BASE PAY SDK LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  @base-org/account                                        │ │
│  ├──────────────────────────────────────────────────────────┤ │
│  │  • pay({ amount, to, testnet })                          │ │
│  │  • getPaymentStatus({ id, testnet })                     │ │
│  │  • Handles wallet popup                                  │ │
│  │  • Manages USDC transfers                                │ │
│  │  • Sponsors gas fees                                     │ │
│  └──────────────────────┬───────────────────────────────────┘ │
│                         │                                       │
└─────────────────────────┼───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BLOCKCHAIN LAYER                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────────┐         ┌────────────────────┐        │
│  │   Base Sepolia     │         │   Base Mainnet     │        │
│  │   (Testnet)        │         │   (Production)     │        │
│  ├────────────────────┤         ├────────────────────┤        │
│  │ Chain ID: 84532    │         │ Chain ID: 8453     │        │
│  │ Free Test USDC     │         │ Real USDC          │        │
│  │ Circle Faucet      │         │ ~2s settlements    │        │
│  └────────────────────┘         └────────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Payment Flow Sequence

```
┌──────┐          ┌──────────┐          ┌──────────┐          ┌──────────┐
│ User │          │ XPStore  │          │ basePay  │          │ Base Pay │
│      │          │Component │          │ Service  │          │   SDK    │
└──┬───┘          └────┬─────┘          └────┬─────┘          └────┬─────┘
   │                   │                     │                      │
   │ Click "Buy XP"    │                     │                      │
   ├──────────────────>│                     │                      │
   │                   │                     │                      │
   │                   │ processPayment()    │                      │
   │                   ├────────────────────>│                      │
   │                   │                     │                      │
   │                   │                     │ pay()                │
   │                   │                     ├─────────────────────>│
   │                   │                     │                      │
   │                   │                     │  ┌──────────────┐   │
   │                   │                     │  │ Base Pay     │   │
   │<──────────────────┼─────────────────────┼──│ Popup Opens  │   │
   │  Popup Appears    │                     │  └──────────────┘   │
   │                   │                     │                      │
   │ Complete Payment  │                     │                      │
   ├───────────────────┼─────────────────────┼─────────────────────>│
   │                   │                     │                      │
   │                   │                     │ { id: "0x123..." }   │
   │                   │                     │<─────────────────────┤
   │                   │                     │                      │
   │                   │  { id, status }     │                      │
   │                   │<────────────────────┤                      │
   │                   │                     │                      │
   │                   │ pollPaymentStatus() │                      │
   │                   ├────────────────────>│                      │
   │                   │                     │                      │
   │                   │                     │ getPaymentStatus()   │
   │                   │                     ├─────────────────────>│
   │                   │                     │                      │
   │                   │                     │ { status: "pending" }│
   │                   │                     │<─────────────────────┤
   │                   │                     │                      │
   │                   │                     │ Wait 2s...           │
   │                   │                     │                      │
   │                   │                     │ getPaymentStatus()   │
   │                   │                     ├─────────────────────>│
   │                   │                     │                      │
   │                   │                     │{ status: "completed"}│
   │                   │                     │<─────────────────────┤
   │                   │                     │                      │
   │                   │  "completed"        │                      │
   │                   │<────────────────────┤                      │
   │                   │                     │                      │
   │                   │ addXP()             │                      │
   │                   ├─────────────┐       │                      │
   │                   │             │       │                      │
   │                   │<────────────┘       │                      │
   │                   │                     │                      │
   │ Success Toast     │                     │                      │
   │<──────────────────┤                     │                      │
   │                   │                     │                      │
```

## 🗂️ Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      CONFIGURATION                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  basePay.ts Config                                             │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ PAYMENT_RECIPIENT_ADDRESS = "0x742d35..."              │  │
│  │ IS_TESTNET = true                                       │  │
│  │ PAYMENT_POLLING_CONFIG = { maxAttempts, intervalMs }   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PAYMENT INITIATION                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User selects XP package                                       │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ Package: "Popular"                                      │  │
│  │ Price: "$10.00"                                         │  │
│  │ XP: 1100 (1000 base + 10% bonus)                       │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   PAYMENT PROCESSING                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  processPayment() called                                       │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ {                                                        │  │
│  │   amount: "10.00",                                      │  │
│  │   to: "0x742d35...",                                    │  │
│  │   testnet: true                                         │  │
│  │ }                                                        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PAYMENT RESPONSE                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Base Pay SDK returns                                          │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ {                                                        │  │
│  │   id: "0x123abc...",                                    │  │
│  │   status: "pending"                                     │  │
│  │ }                                                        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STATUS POLLING                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  pollPaymentStatus() loop                                      │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ Attempt 1: status = "pending"  (wait 2s)               │  │
│  │ Attempt 2: status = "completed" ✓                       │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    XP CREDITING                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  addXP() called                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ addXP(                                                   │  │
│  │   amount: 1100,                                         │  │
│  │   type: "purchase",                                     │  │
│  │   txHash: "0x123abc..."                                 │  │
│  │ )                                                        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────┼──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    USER FEEDBACK                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Success notification                                          │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ ✓ Successfully purchased 1,100 XP!                      │  │
│  │ Transaction ID: 0x123abc...                             │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Updated XP balance displayed                                  │
│  Previous: 500 XP → New: 1,600 XP                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🧩 Component Relationships

```
┌─────────────────────────────────────────────────────────────┐
│                      Index.tsx                              │
│                   (Main Page)                               │
└────┬──────────────────────────────┬─────────────────────────┘
     │                              │
     │                              │
     ▼                              ▼
┌─────────────────┐          ┌─────────────────┐
│  XPBalanceDisplay│          │   XPStore      │
│   Component      │          │   Component    │
└─────────────────┘          └────┬────────────┘
                                  │
                                  │ uses
                                  │
                                  ▼
                            ┌─────────────────┐
                            │  basePay.ts     │
                            │   (Service)     │
                            └────┬────────────┘
                                 │
                                 │ imports config
                                 │
                                 ▼
                            ┌─────────────────┐
                            │ basePay.ts      │
                            │  (Config)       │
                            └─────────────────┘
```

## 🔐 Security Flow

```
┌─────────────┐
│   CLIENT    │
│  (Browser)  │
└──────┬──────┘
       │
       │ 1. Request Payment
       │ (amount, recipient)
       ▼
┌──────────────────┐
│   Base Pay SDK   │
│  (Client-side)   │
└──────┬───────────┘
       │
       │ 2. Show Popup
       │ 3. User Signs with Wallet
       │
       ▼
┌──────────────────┐
│  Base Blockchain │
│   (On-chain)     │
└──────┬───────────┘
       │
       │ 4. USDC Transfer
       │    From: User Wallet
       │    To: Recipient Address
       │    Gas: Sponsored
       │
       ▼
┌──────────────────┐
│  Transaction     │
│   Confirmed      │
└──────┬───────────┘
       │
       │ 5. Poll Status
       │    (client checks confirmation)
       │
       ▼
┌──────────────────┐
│  Credit XP       │
│  (off-chain)     │
└──────────────────┘

⚠️ PRODUCTION NOTE:
   Need server-side validation!
   Don't trust client XP credits.
```

## 📊 State Management

```
┌─────────────────────────────────────────────────────────┐
│                  XP State Flow                          │
└─────────────────────────────────────────────────────────┘

Current Implementation (localStorage):

┌──────────┐     ┌──────────┐     ┌──────────┐
│  User    │────>│ Payment  │────>│ Add XP   │
│ Wallet   │     │Confirmed │     │ Balance  │
└──────────┘     └──────────┘     └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │localStorage
                                  │ {         │
                                  │  balance, │
                                  │  history  │
                                  │ }         │
                                  └──────────┘

Production Implementation (Recommended):

┌──────────┐     ┌──────────┐     ┌──────────┐
│  User    │────>│ Payment  │────>│ Backend  │
│ Wallet   │     │Confirmed │     │  API     │
└──────────┘     └──────────┘     └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │ Database │
                                  │ (Postgres│
                                  │  /Mongo) │
                                  └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │ Update   │
                                  │  Client  │
                                  └──────────┘
```

---

**Legend:**
- `→` Direct function call
- `├─>` Async operation
- `┌─┐` Component/Service boundary
- `▼` Data flow direction
- `✓` Success state
- `⚠️` Warning/Important note
